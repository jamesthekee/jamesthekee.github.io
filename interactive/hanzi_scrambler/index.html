<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hanzi scrambler</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            margin: 0;
            padding: 20px;
            box-sizing: border-box;
        }

        .container {
            width: 100%;
            max-width: 600px;
            text-align: center;
        }

        textarea {
            width: 100%;
            height: 100px;
            margin: 10px 0;
            padding: 10px;
            box-sizing: border-box;
            resize: vertical;
        }

        button {
            padding: 10px 20px;
            margin: 10px 0;
            cursor: pointer;
        }

        .output-container {
            margin-top: 20px;
        }
    </style>
</head>

<body>
    <div class="container">
        <h1>Chinese Hanzi Converter</h1>
        <p>Enter Chinese characters to convert to pinyin and map to different characters</p>

        <textarea id="inputText" placeholder="Enter Chinese characters here..."></textarea>
        <br>
        <input type="checkbox" id="random" name="random" value="random">
        <label for="random"> Randomize</label>
        <input type="checkbox" id="toneless" name="toneless" value="toneless">
        <label for="toneless"> Toneless</label><br>
        <button id="convertBtn">Convert</button>

        <div class="output-container">
            <h3>Output:</h3>
            <textarea id="outputText" readonly placeholder="Result will appear here..."></textarea>
        </div>
    </div>

    <script>
        let jsonData;
        async function fetchData() {
            try {
                const response = await fetch('https://jamesthekee.github.io/assets/data/data.json');
                jsonData = await response.json();
                console.log(jsonData)
            } catch (error) {
                console.error(error);
            }
        }
        fetchData();


        document.getElementById('convertBtn').addEventListener('click', function () {
            const inputText = document.getElementById('inputText').value;
            const outputText = convertHanziText(inputText);
            document.getElementById('outputText').value = outputText;
        });

        function convertHanziText(input) {
            let result = '';
            let doRandom = document.getElementById("random").checked || false;
            let toneless = document.getElementById("toneless").checked || false;


            for (let char of input) {
                if (jsonData.char[char]) {
                    if (doRandom)
                        result += convertHanziRandom(char)
                    else
                        result += convertHanzi(char);
                } else {
                    // Keep non-Chinese characters as is
                    result += char;
                }
            }
            return result;
        }

        function convertHanziRandom(char, toneless) {
            const pinyin = jsonData.char[char];

            // Try to find a different character with the same pinyin
            const samePinyinChars = jsonData.sound[pinyin] || [];
            let differentChar = '';
            let candidate;
            
            if( toneless && samePinyinChars.length > 1){
                while(true){
                    candidate = samePinyinChars[Math.floor(Math.random() * samePinyinChars.length)];
                    if (candidate !== char) {
                        differentChar = candidate;
                        break;
                    }
                }
            }
            // If no exact match found, try toneless pinyin
            if (!differentChar) {
                const tonelessPinyin = pinyin.replace(/[1-5]/, '');
                const tonelessChars = jsonData.toneless[tonelessPinyin] || [];

                if( tonelessChars.length > 1){
                    while(true){
                        candidate = tonelessChars[Math.floor(Math.random() * tonelessChars.length)];
                        if (candidate !== char) {
                            differentChar = candidate;
                            break;
                        }
                    }
                }
            }
            return differentChar || char;
        }

        function convertHanzi(char, toneless) {
            const pinyin = jsonData.char[char];
            console.log(pinyin);
            console.log(char);


            // Try to find a different character with the same pinyin
            const samePinyinChars = jsonData.sound[pinyin] || [];
            let differentChar = '';
            
            if( toneless){
                for (let candidate of samePinyinChars) {
                    if (candidate !== char) {
                        differentChar = candidate;
                        break;
                    }
                }
            }
            // If no exact match found, try toneless pinyin
            if (!differentChar) {
                const tonelessPinyin = pinyin.replace(/[1-5]/, '');
                const tonelessChars = jsonData.toneless[tonelessPinyin] || [];

                for (let candidate of tonelessChars) {
                    if (candidate !== char) {
                        differentChar = candidate;
                        break;
                    }
                }
            }
            return differentChar || char;
        }
    </script>
</body>

</html>